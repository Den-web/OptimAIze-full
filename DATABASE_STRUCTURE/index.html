<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Структура базы данных - optimAIze Docs</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430 \u0431\u0430\u0437\u044b \u0434\u0430\u043d\u043d\u044b\u0445";
        var mkdocs_page_input_path = "DATABASE_STRUCTURE.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> optimAIze Docs
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="../README.md">Главная</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TECH_STACK/">Технический стек</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Архитектура</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../BACKEND_ARCHITECTURE/">Архитектура backend</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../SAAS_EXPRESS_ARCHITECTURE/">Архитектура SaaS/Express</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ADVANCED_ARCHITECTURE/">Расширенная архитектура</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Структура базы данных</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#_2">Основные сущности</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#users">Пользователи (users)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#organizations">Организации (organizations)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#projects">Проекты (projects)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#subscription_plans">Подписки (subscription_plans)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#organization_members">Члены организации (organization_members)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#audit_logs">Логи действий (audit_logs)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rls-row-level-security">RLS (Row Level Security)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sql">Пример схемы (SQL)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_3">Примечания</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_4">Дополнительные сущности для проектов</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#roles">Роли (roles)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#rules">Правила (rules)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#prompts">Промпты (prompts)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#chats">Чаты (chats)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#chat_messages">Сообщения чата (chat_messages)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sql_1">Пример схемы (SQL) — расширение</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_5">Связи и пояснения</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rls-row-level-security_1">RLS (Row Level Security)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_6">Шаринг промптов по ссылке</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#rls">RLS для публичных промптов</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../PROJECT_STRUCTURE/">Структура проекта</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Дорожные карты</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../MVP_ROADMAP/">Дорожная карта MVP</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../IMPLEMENTATION_ROADMAP/">Дорожная карта реализации</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Разработка</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../DEVELOPMENT_TRACKER/">Трекер разработки</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../FRONTEND_STATUS/">Frontend статус</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">optimAIze Docs</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Архитектура</li>
      <li class="breadcrumb-item active">Структура базы данных</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="_1">Структура базы данных</h1>
<h2 id="_2">Основные сущности</h2>
<h3 id="users">Пользователи (<code>users</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK, внешний ключ на auth.users)</li>
<li><code>email</code> (text, уникальный)</li>
<li><code>full_name</code> (text)</li>
<li><code>avatar_url</code> (text)</li>
<li><code>created_at</code> (timestamptz)</li>
<li><code>updated_at</code> (timestamptz)</li>
</ul>
<h3 id="organizations">Организации (<code>organizations</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>name</code> (text, not null)</li>
<li><code>slug</code> (text, уникальный)</li>
<li><code>plan_id</code> (text, FK на subscription_plans)</li>
<li><code>owner_id</code> (uuid, FK на users)</li>
<li><code>created_at</code> (timestamptz)</li>
</ul>
<h3 id="projects">Проекты (<code>projects</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>name</code> (text, not null)</li>
<li><code>organization_id</code> (uuid, FK на organizations)</li>
<li><code>created_at</code> (timestamptz)</li>
<li><code>updated_at</code> (timestamptz)</li>
</ul>
<h3 id="subscription_plans">Подписки (<code>subscription_plans</code>)</h3>
<ul>
<li><code>id</code> (text, PK)</li>
<li><code>name</code> (text, not null)</li>
<li><code>price</code> (numeric, not null)</li>
<li><code>features</code> (jsonb)</li>
</ul>
<h3 id="organization_members">Члены организации (<code>organization_members</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>organization_id</code> (uuid, FK на organizations)</li>
<li><code>user_id</code> (uuid, FK на users)</li>
<li><code>role</code> (text, например: owner, admin, member)</li>
<li><code>joined_at</code> (timestamptz)</li>
</ul>
<h3 id="audit_logs">Логи действий (<code>audit_logs</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>user_id</code> (uuid, FK на users)</li>
<li><code>organization_id</code> (uuid, FK на organizations)</li>
<li><code>action</code> (text)</li>
<li><code>details</code> (jsonb)</li>
<li><code>created_at</code> (timestamptz)</li>
</ul>
<h2 id="rls-row-level-security">RLS (Row Level Security)</h2>
<ul>
<li>Включена для всех таблиц с пользовательскими данными</li>
<li>Примеры политик:</li>
<li>Пользователь видит только свои данные</li>
<li>Член организации видит только свои организации и проекты</li>
<li>Только owner/admin может изменять организацию</li>
</ul>
<h2 id="sql">Пример схемы (SQL)</h2>
<pre><code class="language-sql">create table public.users (
  id uuid references auth.users primary key,
  email text unique,
  full_name text,
  avatar_url text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.organizations (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  slug text unique not null,
  plan_id text references public.subscription_plans(id),
  owner_id uuid references public.users(id),
  created_at timestamptz default now()
);

create table public.projects (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  organization_id uuid references public.organizations(id),
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.subscription_plans (
  id text primary key,
  name text not null,
  price numeric not null,
  features jsonb default '{}'::jsonb
);

create table public.organization_members (
  id uuid default gen_random_uuid() primary key,
  organization_id uuid references public.organizations(id),
  user_id uuid references public.users(id),
  role text not null,
  joined_at timestamptz default now()
);

create table public.audit_logs (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.users(id),
  organization_id uuid references public.organizations(id),
  action text not null,
  details jsonb default '{}'::jsonb,
  created_at timestamptz default now()
);

-- Пример RLS политики
alter table public.users enable row level security;
create policy &quot;Users can read own data&quot;
  on public.users for select
  using (auth.uid() = id);

alter table public.organization_members enable row level security;
create policy &quot;Org members can access org data&quot;
  on public.organization_members for all
  using (auth.uid() = user_id);
</code></pre>
<h2 id="_3">Примечания</h2>
<ul>
<li>Все таблицы используют uuid как PK для масштабируемости</li>
<li>RLS обеспечивает безопасность данных на уровне строк</li>
<li>Для расширения: добавить таблицы для файлов, платежей, уведомлений, аналитики </li>
</ul>
<h2 id="_4">Дополнительные сущности для проектов</h2>
<h3 id="roles">Роли (<code>roles</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>project_id</code> (uuid, FK на projects)</li>
<li><code>name</code> (text, not null)</li>
<li><code>category</code> (text, например: technical, business, creative)</li>
<li><code>description</code> (text)</li>
<li><code>content</code> (text) — инструкции для роли</li>
<li><code>expertise</code> (jsonb) — массив областей экспертизы</li>
<li><code>is_default</code> (boolean)</li>
<li><code>created_at</code> (timestamptz)</li>
<li><code>updated_at</code> (timestamptz)</li>
</ul>
<h3 id="rules">Правила (<code>rules</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>project_id</code> (uuid, FK на projects)</li>
<li><code>name</code> (text, not null)</li>
<li><code>description</code> (text)</li>
<li><code>content</code> (text) — формулировка правила</li>
<li><code>created_at</code> (timestamptz)</li>
<li><code>updated_at</code> (timestamptz)</li>
</ul>
<h3 id="prompts">Промпты (<code>prompts</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>project_id</code> (uuid, FK на projects)</li>
<li><code>title</code> (text, not null)</li>
<li><code>description</code> (text)</li>
<li><code>content</code> (text)</li>
<li><code>is_public</code> (boolean, default false) — публичный ли промпт</li>
<li><code>public_id</code> (text, уникальный, nullable) — публичный идентификатор для шаринга</li>
<li><code>created_at</code> (timestamptz)</li>
<li><code>updated_at</code> (timestamptz)</li>
</ul>
<h3 id="chats">Чаты (<code>chats</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>project_id</code> (uuid, FK на projects)</li>
<li><code>user_id</code> (uuid, FK на users)</li>
<li><code>title</code> (text)</li>
<li><code>created_at</code> (timestamptz)</li>
<li><code>updated_at</code> (timestamptz)</li>
</ul>
<h3 id="chat_messages">Сообщения чата (<code>chat_messages</code>)</h3>
<ul>
<li><code>id</code> (uuid, PK)</li>
<li><code>chat_id</code> (uuid, FK на chats)</li>
<li><code>role</code> (text, 'user' | 'assistant')</li>
<li><code>content</code> (text)</li>
<li><code>created_at</code> (timestamptz)</li>
</ul>
<h2 id="sql_1">Пример схемы (SQL) — расширение</h2>
<pre><code class="language-sql">-- ... существующие таблицы ...

create table public.roles (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id),
  name text not null,
  category text,
  description text,
  content text,
  expertise jsonb,
  is_default boolean default false,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.rules (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id),
  name text not null,
  description text,
  content text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.prompts (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id),
  title text not null,
  description text,
  content text,
  is_public boolean default false,
  public_id text unique,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.chats (
  id uuid default gen_random_uuid() primary key,
  project_id uuid references public.projects(id),
  user_id uuid references public.users(id),
  title text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table public.chat_messages (
  id uuid default gen_random_uuid() primary key,
  chat_id uuid references public.chats(id),
  role text not null,
  content text,
  created_at timestamptz default now()
);
</code></pre>
<h2 id="_5">Связи и пояснения</h2>
<ul>
<li>Проект — центральная сущность, к которой привязаны роли, правила, промпты, чаты.</li>
<li>Чат принадлежит проекту и пользователю.</li>
<li>Сообщения чата принадлежат чату.</li>
<li>Роли, правила, промпты — могут быть как дефолтными (is_default), так и кастомными для проекта.</li>
</ul>
<h2 id="rls-row-level-security_1">RLS (Row Level Security)</h2>
<ul>
<li>Доступ к проекту и связанным сущностям только для участников организации/проекта.</li>
<li>Чаты и сообщения доступны только их владельцу и участникам проекта.</li>
</ul>
<h2 id="_6">Шаринг промптов по ссылке</h2>
<ul>
<li>Если <code>is_public = true</code> и <code>public_id</code> не null — промпт доступен по ссылке <code>/prompts/share/{public_id}</code>.</li>
<li>При создании публичного промпта генерируется уникальный <code>public_id</code> (uuid или hash).</li>
<li>Приватные промпты доступны только участникам проекта.</li>
</ul>
<h3 id="rls">RLS для публичных промптов</h3>
<pre><code class="language-sql">-- Разрешить читать публичные промпты всем
create policy &quot;Public prompts are readable&quot;
  on public.prompts for select
  using (is_public = true);
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ADVANCED_ARCHITECTURE/" class="btn btn-neutral float-left" title="Расширенная архитектура"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../PROJECT_STRUCTURE/" class="btn btn-neutral float-right" title="Структура проекта">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../ADVANCED_ARCHITECTURE/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../PROJECT_STRUCTURE/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
